#!/usr/bin/env php
<?php

/**
 * WordPress Boost MCP Server
 *
 * Standalone entry point for running the MCP server.
 * Can be used without WP-CLI: php wp-boost --path=/path/to/wordpress
 */

declare(strict_types=1);

// Find autoloader
$autoloadPaths = [
    __DIR__ . '/../vendor/autoload.php',           // When installed as a project
    __DIR__ . '/../../../autoload.php',            // When installed as a dependency
];

$autoloaderFound = false;
foreach ($autoloadPaths as $autoloadPath) {
    if (file_exists($autoloadPath)) {
        require $autoloadPath;
        $autoloaderFound = true;
        break;
    }
}

if (!$autoloaderFound) {
    fwrite(STDERR, "Error: Could not find Composer autoloader.\n");
    fwrite(STDERR, "Run 'composer install' to install dependencies.\n");
    exit(1);
}

use WordPressBoost\McpServer;
use WordPressBoost\WordPress\Bootstrap;

// Parse command line arguments
$options = getopt('', ['path:', 'help', 'version', 'init']);

if (isset($options['help'])) {
    echo <<<HELP
WordPress Boost MCP Server

Usage:
  wp-boost [options]

Options:
  --path=<path>    Path to WordPress installation (default: current directory)
  --init           Create .mcp.json configuration file in current directory
  --help           Display this help message
  --version        Display version information

Examples:
  wp-boost --init                              # Create .mcp.json config
  wp-boost                                     # Run MCP server
  wp-boost --path=/var/www/html/wordpress      # Run with custom path

HELP;
    exit(0);
}

if (isset($options['version'])) {
    echo "WordPress Boost v0.1.0\n";
    exit(0);
}

if (isset($options['init'])) {
    $configPath = getcwd() . '/.mcp.json';

    if (file_exists($configPath)) {
        echo "⚠ .mcp.json already exists at: $configPath\n";
        echo "Delete it first if you want to regenerate.\n";
        exit(1);
    }

    // Determine the correct path to wp-boost binary
    $wpBoostPath = 'vendor/bin/wp-boost';

    $config = [
        'servers' => [
            'wordpress-boost' => [
                'command' => 'php',
                'args' => [$wpBoostPath],
            ],
        ],
    ];

    $json = json_encode($config, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES);

    if (file_put_contents($configPath, $json . "\n") === false) {
        fwrite(STDERR, "Error: Could not write .mcp.json\n");
        exit(1);
    }

    echo "✓ Created .mcp.json\n";
    echo "\nNext steps:\n";
    echo "  1. Open this folder in your AI editor (Cursor, VS Code, Windsurf)\n";
    echo "  2. The MCP server will be available automatically\n";
    echo "\nFor Claude Code:\n";
    echo "  claude mcp add wordpress-boost -- php vendor/bin/wp-boost\n";
    exit(0);
}

// Determine WordPress path
$wpPath = $options['path'] ?? getcwd();

// Bootstrap WordPress
try {
    $bootstrap = new Bootstrap($wpPath);
    $bootstrap->load();
} catch (\Exception $e) {
    fwrite(STDERR, "Error: " . $e->getMessage() . "\n");
    exit(1);
}

// Start MCP server
$server = new McpServer();
$server->run();
