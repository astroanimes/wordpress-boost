#!/usr/bin/env php
<?php

/**
 * WordPress Boost MCP Server
 *
 * Standalone entry point for running the MCP server.
 * Can be used without WP-CLI: php wp-boost --path=/path/to/wordpress
 */

declare(strict_types=1);

// Find autoloader
$autoloadPaths = [
    __DIR__ . '/../vendor/autoload.php',           // When running as a project (bin/wp-boost)
    __DIR__ . '/../autoload.php',                  // When in vendor/bin/ (Composer copies bin files)
    __DIR__ . '/../../../autoload.php',            // When symlinked from vendor/bin to vendor/package/bin
];

$autoloaderFound = false;
foreach ($autoloadPaths as $autoloadPath) {
    if (file_exists($autoloadPath)) {
        require $autoloadPath;
        $autoloaderFound = true;
        break;
    }
}

if (!$autoloaderFound) {
    fwrite(STDERR, "Error: Could not find Composer autoloader.\n");
    fwrite(STDERR, "Run 'composer install' to install dependencies.\n");
    exit(1);
}

use WordPressBoost\McpServer;
use WordPressBoost\WordPress\Bootstrap;

// Parse command line arguments
$options = getopt('', ['path:', 'help', 'version', 'init']);

if (isset($options['help'])) {
    echo <<<HELP
WordPress Boost MCP Server

Usage:
  wp-boost [options]

Options:
  --path=<path>    Path to WordPress installation (default: current directory)
  --init           Create .mcp.json configuration file in current directory
  --help           Display this help message
  --version        Display version information

Examples:
  wp-boost --init                              # Create .mcp.json config
  wp-boost                                     # Run MCP server
  wp-boost --path=/var/www/html/wordpress      # Run with custom path

HELP;
    exit(0);
}

if (isset($options['version'])) {
    echo "WordPress Boost v0.1.0\n";
    exit(0);
}

if (isset($options['init'])) {
    $configPath = getcwd() . '/.mcp.json';
    $wpBoostPath = 'vendor/bin/wp-boost';

    $wordpressBoostConfig = [
        'command' => 'php',
        'args' => [$wpBoostPath],
    ];

    // Check if .mcp.json already exists
    if (file_exists($configPath)) {
        $existingContent = file_get_contents($configPath);
        $existingConfig = json_decode($existingContent, true);

        if (json_last_error() !== JSON_ERROR_NONE) {
            fwrite(STDERR, "Error: Existing .mcp.json is not valid JSON\n");
            exit(1);
        }

        // Check if wordpress-boost is already configured
        $serverKey = $existingConfig['mcpServers'] ?? $existingConfig['servers'] ?? [];
        if (isset($serverKey['wordpress-boost'])) {
            echo "✓ wordpress-boost is already configured in .mcp.json\n";
            exit(0);
        }

        // Add wordpress-boost to existing config (support both formats)
        if (isset($existingConfig['mcpServers'])) {
            $existingConfig['mcpServers']['wordpress-boost'] = $wordpressBoostConfig;
        } elseif (isset($existingConfig['servers'])) {
            $existingConfig['servers']['wordpress-boost'] = $wordpressBoostConfig;
        } else {
            $existingConfig['mcpServers'] = ['wordpress-boost' => $wordpressBoostConfig];
        }

        $config = $existingConfig;
        echo "✓ Added wordpress-boost to existing .mcp.json\n";
    } else {
        // Create new config
        $config = [
            'mcpServers' => [
                'wordpress-boost' => $wordpressBoostConfig,
            ],
        ];
        echo "✓ Created .mcp.json\n";
    }

    $json = json_encode($config, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES);

    if (file_put_contents($configPath, $json . "\n") === false) {
        fwrite(STDERR, "Error: Could not write .mcp.json\n");
        exit(1);
    }

    echo "\nNext steps:\n";
    echo "  1. Open this folder in your AI editor (Cursor, VS Code, Windsurf)\n";
    echo "  2. The MCP server will be available automatically\n";
    echo "\nFor Claude Code:\n";
    echo "  claude mcp add wordpress-boost -- php vendor/bin/wp-boost\n";
    exit(0);
}

// Determine WordPress path
// Priority: 1) --path argument, 2) script location (walk up to find wp-load.php), 3) getcwd()
$wpPath = $options['path'] ?? null;

if ($wpPath === null) {
    // Try to find WordPress by walking up from the script's location
    // This works when wp-boost is installed as a dependency in a theme/plugin
    $path = __DIR__;
    $maxDepth = 15; // Enough depth for themes/plugins in subdirectories

    for ($i = 0; $i < $maxDepth; $i++) {
        if (file_exists($path . '/wp-load.php')) {
            $wpPath = $path;
            break;
        }
        $parentPath = dirname($path);
        if ($parentPath === $path) {
            break;
        }
        $path = $parentPath;
    }

    // Fall back to current working directory if not found from script location
    if ($wpPath === null) {
        $wpPath = getcwd();
    }
}

// Bootstrap WordPress
try {
    $bootstrap = new Bootstrap($wpPath);
    $bootstrap->load();
} catch (\Exception $e) {
    fwrite(STDERR, "Error: " . $e->getMessage() . "\n");
    exit(1);
}

// Start MCP server
$server = new McpServer();
$server->run();
